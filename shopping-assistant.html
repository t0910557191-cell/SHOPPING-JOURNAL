<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>æ¡è³¼æ‰‹å¸³</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;1,300;1,400&family=Noto+Serif+TC:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --cream: #f5f0e8;
    --warm-white: #faf8f4;
    --gold: #b8965a;
    --gold-light: #d4b07a;
    --gold-pale: #e8d5b0;
    --dark: #2a2218;
    --mid: #5a4e3c;
    --light: #8a7d68;
    --divider: #ddd5c0;
    --status-buy: #7a9e7e;
    --status-bought: #4a7a8a;
    --status-pass: #b07a7a;
    --status-catalog: #9a7aaa;
    --accent: #c4956a;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--cream);
    color: var(--dark);
    font-family: 'Noto Serif TC', serif;
    font-weight: 300;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* â”€â”€ Header â”€â”€ */
  .header {
    background: var(--dark);
    color: var(--gold-pale);
    padding: 16px 20px 12px;
    position: sticky;
    top: 0;
    z-index: 100;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .header-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: 22px;
    font-weight: 300;
    letter-spacing: 4px;
    color: var(--gold-light);
  }
  .header-sub {
    font-size: 10px;
    letter-spacing: 3px;
    color: var(--light);
    margin-top: 2px;
  }
  .header-actions {
    display: flex;
    gap: 8px;
  }
  .btn-icon {
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(184,150,90,0.3);
    color: var(--gold-light);
    padding: 6px 12px;
    border-radius: 2px;
    font-size: 11px;
    letter-spacing: 2px;
    cursor: pointer;
    font-family: 'Noto Serif TC', serif;
    transition: all 0.2s;
  }
  .btn-icon:hover { background: rgba(184,150,90,0.2); }

  /* â”€â”€ Tab nav â”€â”€ */
  .tab-nav {
    background: var(--dark);
    border-bottom: 1px solid rgba(184,150,90,0.2);
    display: flex;
    padding: 0 20px;
    gap: 0;
  }
  .tab {
    padding: 10px 18px;
    font-size: 11px;
    letter-spacing: 2.5px;
    color: var(--light);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .tab.active {
    color: var(--gold-light);
    border-bottom-color: var(--gold);
  }

  /* â”€â”€ Main content â”€â”€ */
  .page { display: none; padding: 0 0 80px; }
  .page.active { display: block; }

  /* â”€â”€ FAB â”€â”€ */
  .fab {
    position: fixed;
    bottom: 24px;
    right: 20px;
    width: 52px;
    height: 52px;
    background: var(--gold);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(184,150,90,0.4);
    border: none;
    transition: transform 0.2s, box-shadow 0.2s;
    z-index: 90;
  }
  .fab:hover { transform: scale(1.05); box-shadow: 0 6px 24px rgba(184,150,90,0.5); }

  /* â”€â”€ Modal â”€â”€ */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(30,24,16,0.7);
    z-index: 200;
    display: none;
    align-items: flex-end;
    backdrop-filter: blur(3px);
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--warm-white);
    width: 100%;
    max-height: 92vh;
    border-radius: 12px 12px 0 0;
    overflow-y: auto;
    padding: 20px 20px 40px;
    animation: slideUp 0.3s ease;
  }
  @keyframes slideUp {
    from { transform: translateY(60px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 14px;
    border-bottom: 1px solid var(--divider);
  }
  .modal-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: 20px;
    color: var(--dark);
    letter-spacing: 2px;
  }
  .modal-close {
    background: none;
    border: none;
    font-size: 20px;
    color: var(--light);
    cursor: pointer;
    padding: 4px 8px;
  }

  /* â”€â”€ Form â”€â”€ */
  .form-section {
    margin-bottom: 18px;
  }
  .form-label {
    font-size: 10px;
    letter-spacing: 2.5px;
    color: var(--light);
    margin-bottom: 6px;
    display: block;
  }
  .form-input, .form-select, .form-textarea {
    width: 100%;
    background: var(--cream);
    border: 1px solid var(--divider);
    border-radius: 3px;
    padding: 10px 12px;
    font-size: 14px;
    color: var(--dark);
    font-family: 'Noto Serif TC', serif;
    font-weight: 300;
    transition: border-color 0.2s;
    -webkit-appearance: none;
  }
  .form-input:focus, .form-select:focus, .form-textarea:focus {
    outline: none;
    border-color: var(--gold);
  }
  .form-textarea { resize: vertical; min-height: 60px; }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  .form-row-3 {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr;
    gap: 8px;
  }

  /* Price row with TWD hint */
  .price-wrap { position: relative; }
  .price-hint {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 11px;
    color: var(--gold);
    pointer-events: none;
    font-style: italic;
  }

  /* Toggle buttons */
  .toggle-group {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }
  .toggle-btn {
    padding: 7px 14px;
    border: 1px solid var(--divider);
    border-radius: 2px;
    font-size: 12px;
    font-family: 'Noto Serif TC', serif;
    background: transparent;
    color: var(--mid);
    cursor: pointer;
    transition: all 0.15s;
    letter-spacing: 1px;
  }
  .toggle-btn.active {
    background: var(--dark);
    border-color: var(--dark);
    color: var(--gold-pale);
  }

  /* Photo area */
  .photo-area {
    border: 1.5px dashed var(--divider);
    border-radius: 4px;
    padding: 16px;
    text-align: center;
    cursor: pointer;
    transition: border-color 0.2s;
    position: relative;
    overflow: hidden;
    display: block;
  }
  .photo-area:hover { border-color: var(--gold); }
  .photo-preview {
    width: 100%;
    max-height: 160px;
    object-fit: contain;
    border-radius: 2px;
  }
  .photo-placeholder {
    color: var(--light);
    font-size: 12px;
    letter-spacing: 1.5px;
  }
  .photo-icon { font-size: 28px; margin-bottom: 6px; }

  /* Discount section */
  .discount-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 8px;
  }
  .discount-toggle {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    user-select: none;
  }
  .discount-toggle input { display: none; }
  .discount-dot {
    width: 16px;
    height: 16px;
    border: 1.5px solid var(--divider);
    border-radius: 50%;
    background: transparent;
    transition: all 0.2s;
    flex-shrink: 0;
  }
  .discount-toggle input:checked ~ .discount-dot {
    background: var(--gold);
    border-color: var(--gold);
  }
  .discount-label { font-size: 12px; color: var(--mid); letter-spacing: 1px; }

  /* Save button */
  .btn-save {
    width: 100%;
    background: var(--dark);
    color: var(--gold-pale);
    border: none;
    padding: 14px;
    font-size: 12px;
    letter-spacing: 4px;
    cursor: pointer;
    font-family: 'Noto Serif TC', serif;
    border-radius: 3px;
    transition: background 0.2s;
    margin-top: 6px;
  }
  .btn-save:hover { background: #3d3020; }

  /* â”€â”€ Records â”€â”€ */
  .filter-bar {
    padding: 12px 16px;
    background: var(--warm-white);
    border-bottom: 1px solid var(--divider);
    display: flex;
    gap: 6px;
    overflow-x: auto;
    scrollbar-width: none;
  }
  .filter-bar::-webkit-scrollbar { display: none; }
  .filter-chip {
    padding: 5px 12px;
    border: 1px solid var(--divider);
    border-radius: 20px;
    font-size: 11px;
    letter-spacing: 1.5px;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.15s;
    background: transparent;
    color: var(--mid);
    font-family: 'Noto Serif TC', serif;
  }
  .filter-chip.active {
    background: var(--dark);
    border-color: var(--dark);
    color: var(--gold-pale);
  }

  .record-list { padding: 12px 16px; display: flex; flex-direction: column; gap: 10px; }

  .record-card {
    background: var(--warm-white);
    border: 1px solid var(--divider);
    border-radius: 4px;
    overflow: hidden;
    transition: box-shadow 0.2s;
  }
  .record-card:hover { box-shadow: 0 2px 12px rgba(42,34,24,0.1); }

  .record-top {
    display: flex;
    gap: 12px;
    padding: 12px;
  }
  .record-thumb {
    width: 64px;
    height: 64px;
    object-fit: cover;
    border-radius: 2px;
    flex-shrink: 0;
    background: var(--cream);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: var(--divider);
  }
  .record-thumb img { width: 100%; height: 100%; object-fit: cover; border-radius: 2px; }

  .record-body { flex: 1; min-width: 0; }
  .record-name {
    font-size: 14px;
    color: var(--dark);
    margin-bottom: 3px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .record-meta {
    font-size: 12px;
    color: var(--light);
    letter-spacing: 0.5px;
    margin-bottom: 4px;
  }
  .record-price {
    font-family: 'Cormorant Garamond', serif;
    font-size: 17px;
    color: var(--dark);
    margin-bottom: 3px;
  }
  .record-price-twd {
    font-size: 12px;
    color: var(--gold);
    margin-left: 4px;
  }
  .record-biz-line {
    font-size: 12px;
    color: var(--light);
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 4px;
  }
  .thumb-wrap {
    flex-shrink: 0;
    text-align: center;
  }

  .record-tags {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
    padding: 0 12px 10px;
  }
  .tag {
    padding: 3px 8px;
    border-radius: 2px;
    font-size: 11px;
    letter-spacing: 0.5px;
  }
  .tag-cat { background: var(--cream); color: var(--mid); border: 1px solid var(--divider); }
  .tag-note { background: var(--warm-white); color: var(--mid); border: 1px solid var(--divider); max-width: 160px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .tag-biz { background: #e8ede8; color: #4a6a4a; }
  .tag-personal { background: #ede8ec; color: #6a4a68; }
  .tag-discount { background: #fdf3e3; color: var(--accent); border: 1px solid var(--gold-pale); }
  .tag-catalog { background: #f0edf5; color: var(--status-catalog); }

  .record-bottom {
    border-top: 1px solid var(--divider);
    padding: 8px 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .status-btns { display: flex; gap: 4px; }
  .status-btn {
    padding: 4px 10px;
    border-radius: 2px;
    font-size: 11px;
    letter-spacing: 1px;
    cursor: pointer;
    border: 1px solid var(--divider);
    background: transparent;
    color: var(--light);
    font-family: 'Noto Serif TC', serif;
    transition: all 0.15s;
  }
  .status-btn.s-buy.active { background: var(--status-buy); border-color: var(--status-buy); color: white; }
  .status-btn.s-bought.active { background: var(--status-bought); border-color: var(--status-bought); color: white; }
  .status-btn.s-pass.active { background: var(--status-pass); border-color: var(--status-pass); color: white; }
  .status-btn.s-catalog.active { background: var(--status-catalog); border-color: var(--status-catalog); color: white; }

  .card-status-row {
    display: flex;
    gap: 5px;
    margin-top: 7px;
  }

  .record-action-btns { display: flex; gap: 6px; }
  .rec-btn {
    background: none;
    border: 1px solid var(--divider);
    color: var(--light);
    font-size: 12px;
    padding: 4px 8px;
    border-radius: 2px;
    cursor: pointer;
    font-family: 'Noto Serif TC', serif;
    transition: all 0.15s;
  }
  .rec-btn:hover { border-color: var(--gold); color: var(--gold); }
  .rec-btn.danger:hover { border-color: var(--status-pass); color: var(--status-pass); }

  /* â”€â”€ Summary page â”€â”€ */
  .summary-section { padding: 16px; }
  .summary-card {
    background: var(--warm-white);
    border: 1px solid var(--divider);
    border-radius: 4px;
    padding: 16px;
    margin-bottom: 12px;
  }
  .summary-card-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: 16px;
    letter-spacing: 3px;
    color: var(--mid);
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--divider);
  }
  .summary-row {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    padding: 5px 0;
    font-size: 13px;
    border-bottom: 1px dotted var(--divider);
  }
  .summary-row:last-child { border: none; }
  .summary-amount {
    font-family: 'Cormorant Garamond', serif;
    font-size: 16px;
    color: var(--dark);
  }

  /* â”€â”€ Settings page â”€â”€ */
  .settings-section { padding: 16px; }
  .settings-group {
    background: var(--warm-white);
    border: 1px solid var(--divider);
    border-radius: 4px;
    margin-bottom: 12px;
    overflow: hidden;
  }
  .settings-group-title {
    padding: 12px 16px;
    font-size: 10px;
    letter-spacing: 3px;
    color: var(--light);
    background: var(--cream);
    border-bottom: 1px solid var(--divider);
  }
  .settings-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid var(--divider);
  }
  .settings-row:last-child { border: none; }
  .settings-row-label { font-size: 13px; color: var(--dark); }
  .settings-input-sm {
    background: var(--cream);
    border: 1px solid var(--divider);
    border-radius: 2px;
    padding: 6px 10px;
    font-size: 14px;
    color: var(--dark);
    font-family: 'Noto Serif TC', serif;
    width: 90px;
    text-align: right;
  }
  .settings-input-sm:focus { outline: none; border-color: var(--gold); }

  .btn-export {
    width: 100%;
    background: transparent;
    border: 1px solid var(--gold);
    color: var(--gold);
    padding: 12px;
    font-size: 11px;
    letter-spacing: 3px;
    cursor: pointer;
    font-family: 'Noto Serif TC', serif;
    border-radius: 3px;
    transition: all 0.2s;
    margin-bottom: 8px;
  }
  .btn-export:hover { background: var(--gold); color: white; }

  /* Batch currency modal */
  .batch-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid var(--divider);
    font-size: 13px;
  }
  .batch-item:last-child { border: none; }

  /* empty state */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--light);
  }
  .empty-icon { font-size: 40px; margin-bottom: 12px; opacity: 0.4; }
  .empty-text { font-size: 13px; letter-spacing: 2px; }

  /* toast */
  .toast {
    position: fixed;
    bottom: 90px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--dark);
    color: var(--gold-pale);
    padding: 10px 20px;
    border-radius: 20px;
    font-size: 12px;
    letter-spacing: 2px;
    opacity: 0;
    transition: all 0.3s;
    z-index: 300;
    pointer-events: none;
  }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  /* Scroll area for catalog to purchase */
  .catalog-convert-btn {
    font-size: 10px;
    padding: 3px 8px;
    letter-spacing: 1px;
  }

  /* Note line under thumb */
  .record-note-line {
    font-size: 11px;
    color: var(--light);
    font-style: italic;
    margin-top: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 64px;
    text-align: center;
  }

  /* Business calc fields */
  .calc-hint {
    font-size: 11px;
    color: var(--gold);
    margin-top: 4px;
    font-style: italic;
    letter-spacing: 0.5px;
  }
  .margin-positive { color: var(--status-buy); }
  .margin-negative { color: var(--status-pass); }

  /* Sort/filter panel */
  .sort-bar {
    background: var(--warm-white);
    border-bottom: 1px solid var(--divider);
    padding: 8px 16px;
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }
  .sort-label {
    font-size: 10px;
    letter-spacing: 2px;
    color: var(--light);
    white-space: nowrap;
  }
  .sort-select {
    background: var(--cream);
    border: 1px solid var(--divider);
    border-radius: 2px;
    padding: 5px 8px;
    font-size: 11px;
    color: var(--mid);
    font-family: 'Noto Serif TC', serif;
    cursor: pointer;
    flex: 1;
    min-width: 0;
  }
  .sort-select:focus { outline: none; border-color: var(--gold); }
  .sort-dir {
    background: var(--cream);
    border: 1px solid var(--divider);
    border-radius: 2px;
    padding: 5px 8px;
    font-size: 12px;
    color: var(--mid);
    cursor: pointer;
    white-space: nowrap;
    font-family: 'Noto Serif TC', serif;
    flex-shrink: 0;
  }
  .sort-dir.asc::after { content: ' â†‘'; }
  .sort-dir.desc::after { content: ' â†“'; }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div>
    <div class="header-title">æ¡è³¼æ‰‹å¸³</div>
    <div class="header-sub">SHOPPING JOURNAL</div>
  </div>
  <div class="header-actions">
    <button class="btn-icon" onclick="openBatchModal()">æ‰¹æ¬¡</button>
    <button class="btn-icon" onclick="openBatchCurrencyModal()">å¹£åˆ¥</button>
  </div>
</div>

<!-- Tab nav -->
<div class="tab-nav">
  <div class="tab active" onclick="switchTab('records')">ç´€éŒ„</div>
  <div class="tab" onclick="switchTab('catalog')">ç›®éŒ„</div>
  <div class="tab" onclick="switchTab('summary')">çµ±è¨ˆ</div>
  <div class="tab" onclick="switchTab('settings')">è¨­å®š</div>
</div>

<!-- Records page -->
<div id="page-records" class="page active">
  <div class="filter-bar">
    <button class="filter-chip active" onclick="setFilter('all', this)">å…¨éƒ¨</button>
    <button class="filter-chip" onclick="setFilter('buy', this)">è¦è²·</button>
    <button class="filter-chip" onclick="setFilter('bought', this)">å·²è²·</button>
    <button class="filter-chip" onclick="setFilter('pass', this)">æ”¾æ£„</button>
    <button class="filter-chip" onclick="setFilter('biz', this)">æ¥­å‹™</button>
    <button class="filter-chip" onclick="setFilter('personal', this)">ç§äºº</button>
  </div>
  <div class="sort-bar">
    <span class="sort-label">ç¯©é¸</span>
    <select class="sort-select" id="filter-country" onchange="renderRecords()">
      <option value="">æ‰€æœ‰åœ‹å®¶</option>
    </select>
    <select class="sort-select" id="filter-city" onchange="renderRecords()">
      <option value="">æ‰€æœ‰åŸå¸‚</option>
    </select>
    <select class="sort-select" id="filter-store" onchange="renderRecords()">
      <option value="">æ‰€æœ‰åº—å</option>
    </select>
    <span class="sort-label">æ’åº</span>
    <select class="sort-select" id="sort-field-records" onchange="renderRecords()">
      <option value="date">æ—¥æœŸ</option>
      <option value="price">æ¡è³¼æˆæœ¬</option>
      <option value="margin">æ¯›åˆ©ç‡</option>
      <option value="qty">æ•¸é‡</option>
      <option value="shipping">é‹è²»</option>
    </select>
    <button class="sort-dir desc" id="sort-dir-records" onclick="toggleSortDir('records')"></button>
  </div>
  <div id="record-list" class="record-list">
    <div class="empty-state">
      <div class="empty-icon">âœ¦</div>
      <div class="empty-text">é»æ“Š + é–‹å§‹è¨˜éŒ„</div>
    </div>
  </div>
</div>

<!-- Catalog page -->
<div id="page-catalog" class="page">
  <div class="sort-bar">
    <span class="sort-label">ç¯©é¸</span>
    <select class="sort-select" id="filter-country-cat" onchange="renderCatalog()">
      <option value="">æ‰€æœ‰åœ‹å®¶</option>
    </select>
    <select class="sort-select" id="filter-city-cat" onchange="renderCatalog()">
      <option value="">æ‰€æœ‰åŸå¸‚</option>
    </select>
    <select class="sort-select" id="filter-store-cat" onchange="renderCatalog()">
      <option value="">æ‰€æœ‰åº—å</option>
    </select>
    <span class="sort-label">æ’åº</span>
    <select class="sort-select" id="sort-field-catalog" onchange="renderCatalog()">
      <option value="date">æ—¥æœŸ</option>
      <option value="price">æ¡è³¼æˆæœ¬</option>
      <option value="margin">æ¯›åˆ©ç‡</option>
      <option value="qty">æ•¸é‡</option>
      <option value="shipping">é‹è²»</option>
    </select>
    <button class="sort-dir desc" id="sort-dir-catalog" onclick="toggleSortDir('catalog')"></button>
  </div>
  <div id="catalog-list" class="record-list">
    <div class="empty-state">
      <div class="empty-icon">â—‡</div>
      <div class="empty-text">è©¢åƒ¹å•†å“æš«å­˜æ–¼æ­¤</div>
    </div>
  </div>
</div>

<!-- Summary page -->
<div id="page-summary" class="page">
  <div class="summary-section" id="summary-content"></div>
</div>

<!-- Settings page -->
<div id="page-settings" class="page">
  <div class="settings-section">
    <div class="settings-group">
      <div class="settings-group-title">åŒ¯ç‡è¨­å®šï¼ˆå°å°å¹£ï¼‰</div>
      <div class="settings-row">
        <span class="settings-row-label">EUR â†’ TWD</span>
        <input type="number" class="settings-input-sm" id="rate-EUR" value="35" onchange="saveRates()">
      </div>
      <div class="settings-row">
        <span class="settings-row-label">RMB â†’ TWD</span>
        <input type="number" class="settings-input-sm" id="rate-RMB" value="4.5" onchange="saveRates()">
      </div>
      <div class="settings-row">
        <span class="settings-row-label">TWD â†’ TWD</span>
        <input type="number" class="settings-input-sm" id="rate-TWD" value="1" readonly style="opacity:0.5">
      </div>
    </div>
    <div class="settings-group">
      <div class="settings-group-title">è³‡æ–™åŒ¯å‡º</div>
      <div style="padding:14px">
        <button class="btn-export" onclick="exportExcel('all')">åŒ¯å‡ºå…¨éƒ¨ç´€éŒ„ Excelï¼ˆå«ç…§ç‰‡ï¼‰</button>
        <button class="btn-export" onclick="exportExcel('biz')">åŒ¯å‡ºæ¥­å‹™ç´€éŒ„ Excelï¼ˆå«ç…§ç‰‡ï¼‰</button>
        <button class="btn-export" onclick="exportExcel('personal')">åŒ¯å‡ºç§äººç´€éŒ„ Excelï¼ˆå«ç…§ç‰‡ï¼‰</button>
        <button class="btn-export" style="font-size:10px;opacity:0.7" onclick="exportCSV('all')">åŒ¯å‡º CSVï¼ˆç´”æ–‡å­—ï¼Œç„¡ç…§ç‰‡ï¼‰</button>
      </div>
    </div>
    <div class="settings-group">
      <div class="settings-group-title">è³‡æ–™ç®¡ç†</div>
      <div style="padding:14px">
        <button class="btn-export" style="border-color:var(--status-pass);color:var(--status-pass)" onclick="clearAll()">æ¸…é™¤å…¨éƒ¨è³‡æ–™</button>
      </div>
    </div>
  </div>
</div>

<!-- FAB -->
<button class="fab" onclick="openAddModal()">ï¼‹</button>

<!-- Add/Edit Modal -->
<div class="modal-overlay" id="add-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-title-text">æ–°å¢ç´€éŒ„</div>
      <button class="modal-close" onclick="closeModal('add-modal')">âœ•</button>
    </div>

    <!-- Photo -->
    <div class="form-section">
      <label class="photo-area" id="photo-area" for="photo-input">
        <input type="file" id="photo-input" accept="image/*" onchange="handlePhoto(event)" style="position:absolute;width:1px;height:1px;opacity:0;pointer-events:none">
        <div id="photo-placeholder" class="photo-placeholder">
          <div class="photo-icon">ğŸ“·</div>
          <div>æ‹ç…§æˆ–é¸æ“‡åœ–ç‰‡</div>
        </div>
        <img id="photo-preview" class="photo-preview" style="display:none">
      </label>
    </div>

    <!-- Name -->
    <div class="form-section">
      <label class="form-label">å•†å“åç¨±</label>
      <input type="text" class="form-input" id="f-name" placeholder="é¸å¡«">
    </div>

    <!-- Country + City + Store -->
    <div class="form-section">
      <label class="form-label">åœ‹å®¶ / åŸå¸‚ / åº—å</label>
      <div class="form-row">
        <select class="form-select" id="f-country">
          <option value="">åœ‹å®¶ï¼ˆé¸å¡«ï¼‰</option>
          <option value="ä¸­åœ‹">ä¸­åœ‹</option>
          <option value="æ—¥æœ¬">æ—¥æœ¬</option>
          <option value="éŸ“åœ‹">éŸ“åœ‹</option>
          <option value="å°ç£">å°ç£</option>
          <option value="é¦™æ¸¯">é¦™æ¸¯</option>
          <option value="æ¾³é–€">æ¾³é–€</option>
          <option value="è’™å¤">è’™å¤</option>
          <option value="æ–°åŠ å¡">æ–°åŠ å¡</option>
          <option value="æ³°åœ‹">æ³°åœ‹</option>
          <option value="è¶Šå—">è¶Šå—</option>
          <option value="é¦¬ä¾†è¥¿äº">é¦¬ä¾†è¥¿äº</option>
          <option value="å°å°¼">å°å°¼</option>
          <option value="è²å¾‹è³“">è²å¾‹è³“</option>
          <option value="ç·¬ç”¸">ç·¬ç”¸</option>
          <option value="æŸ¬åŸ”å¯¨">æŸ¬åŸ”å¯¨</option>
          <option value="å¯®åœ‹">å¯®åœ‹</option>
          <option value="æ±¶èŠ">æ±¶èŠ</option>
          <option value="æ±å¸æ±¶">æ±å¸æ±¶</option>
          <option value="å°åº¦">å°åº¦</option>
          <option value="å·´åŸºæ–¯å¦">å·´åŸºæ–¯å¦</option>
          <option value="å­ŸåŠ æ‹‰">å­ŸåŠ æ‹‰</option>
          <option value="æ–¯é‡Œè˜­å¡">æ–¯é‡Œè˜­å¡</option>
          <option value="å°¼æ³Šçˆ¾">å°¼æ³Šçˆ¾</option>
          <option value="ä¸ä¸¹">ä¸ä¸¹</option>
          <option value="é¦¬çˆ¾åœ°å¤«">é¦¬çˆ¾åœ°å¤«</option>
          <option value="å“ˆè–©å…‹">å“ˆè–©å…‹</option>
          <option value="çƒèŒ²åˆ¥å…‹">çƒèŒ²åˆ¥å…‹</option>
          <option value="åœŸåº«æ›¼">åœŸåº«æ›¼</option>
          <option value="å‰çˆ¾å‰æ–¯">å‰çˆ¾å‰æ–¯</option>
          <option value="å¡”å‰å…‹">å¡”å‰å…‹</option>
          <option value="åœŸè€³å…¶">åœŸè€³å…¶</option>
          <option value="é˜¿è¯é…‹">é˜¿è¯é…‹</option>
          <option value="æ²™çƒåœ°é˜¿æ‹‰ä¼¯">æ²™çƒåœ°é˜¿æ‹‰ä¼¯</option>
          <option value="ä»¥è‰²åˆ—">ä»¥è‰²åˆ—</option>
          <option value="ç´„æ—¦">ç´„æ—¦</option>
          <option value="é»å·´å«©">é»å·´å«©</option>
          <option value="æ•˜åˆ©äº">æ•˜åˆ©äº</option>
          <option value="ä¼Šæ‹‰å…‹">ä¼Šæ‹‰å…‹</option>
          <option value="ä¼Šæœ—">ä¼Šæœ—</option>
          <option value="ç§‘å¨ç‰¹">ç§‘å¨ç‰¹</option>
          <option value="å·´æ—">å·´æ—</option>
          <option value="å¡é”">å¡é”</option>
          <option value="é˜¿æ›¼">é˜¿æ›¼</option>
          <option value="è‘‰é–€">è‘‰é–€</option>
          <option value="äºç¾å°¼äº">äºç¾å°¼äº</option>
          <option value="äºå¡æ‹œç„¶">äºå¡æ‹œç„¶</option>
          <option value="å–¬æ²»äº">å–¬æ²»äº</option>
          <option value="æ³•åœ‹">æ³•åœ‹</option>
          <option value="ç¾©å¤§åˆ©">ç¾©å¤§åˆ©</option>
          <option value="è¥¿ç­ç‰™">è¥¿ç­ç‰™</option>
          <option value="å¾·åœ‹">å¾·åœ‹</option>
          <option value="è‹±åœ‹">è‹±åœ‹</option>
          <option value="è·è˜­">è·è˜­</option>
          <option value="æ¯”åˆ©æ™‚">æ¯”åˆ©æ™‚</option>
          <option value="ç‘å£«">ç‘å£«</option>
          <option value="å¥§åœ°åˆ©">å¥§åœ°åˆ©</option>
          <option value="è‘¡è„ç‰™">è‘¡è„ç‰™</option>
          <option value="ç›§æ£®å ¡">ç›§æ£®å ¡</option>
          <option value="æ„›çˆ¾è˜­">æ„›çˆ¾è˜­</option>
          <option value="æ‘©ç´å“¥">æ‘©ç´å“¥</option>
          <option value="å®‰é“çˆ¾">å®‰é“çˆ¾</option>
          <option value="åˆ—æ”¯æ•¦æ–¯ç™»">åˆ—æ”¯æ•¦æ–¯ç™»</option>
          <option value="é¦¬çˆ¾ä»–">é¦¬çˆ¾ä»–</option>
          <option value="ç‘å…¸">ç‘å…¸</option>
          <option value="æŒªå¨">æŒªå¨</option>
          <option value="ä¸¹éº¥">ä¸¹éº¥</option>
          <option value="èŠ¬è˜­">èŠ¬è˜­</option>
          <option value="å†°å³¶">å†°å³¶</option>
          <option value="æ„›æ²™å°¼äº">æ„›æ²™å°¼äº</option>
          <option value="æ‹‰è„«ç¶­äº">æ‹‰è„«ç¶­äº</option>
          <option value="ç«‹é™¶å®›">ç«‹é™¶å®›</option>
          <option value="æ³¢è˜­">æ³¢è˜­</option>
          <option value="æ·å…‹">æ·å…‹</option>
          <option value="åŒˆç‰™åˆ©">åŒˆç‰™åˆ©</option>
          <option value="æ–¯æ´›ä¼å…‹">æ–¯æ´›ä¼å…‹</option>
          <option value="æ–¯æ´›ç¶­å°¼äº">æ–¯æ´›ç¶­å°¼äº</option>
          <option value="å…‹ç¾…åŸƒè¥¿äº">å…‹ç¾…åŸƒè¥¿äº</option>
          <option value="æ³¢å£«å°¼äº">æ³¢å£«å°¼äº</option>
          <option value="å¡çˆ¾ç¶­äº">å¡çˆ¾ç¶­äº</option>
          <option value="åŒ—é¦¬å…¶é “">åŒ—é¦¬å…¶é “</option>
          <option value="é˜¿çˆ¾å·´å°¼äº">é˜¿çˆ¾å·´å°¼äº</option>
          <option value="è’™ç‰¹å…§å“¥ç¾…">è’™ç‰¹å…§å“¥ç¾…</option>
          <option value="ç§‘ç´¢æ²ƒ">ç§‘ç´¢æ²ƒ</option>
          <option value="ç¾…é¦¬å°¼äº">ç¾…é¦¬å°¼äº</option>
          <option value="ä¿åŠ åˆ©äº">ä¿åŠ åˆ©äº</option>
          <option value="å¸Œè‡˜">å¸Œè‡˜</option>
          <option value="è³½æ™®å‹’æ–¯">è³½æ™®å‹’æ–¯</option>
          <option value="çƒå…‹è˜­">çƒå…‹è˜­</option>
          <option value="ç™½ä¿„ç¾…æ–¯">ç™½ä¿„ç¾…æ–¯</option>
          <option value="æ‘©çˆ¾å¤šç“¦">æ‘©çˆ¾å¤šç“¦</option>
          <option value="ä¿„ç¾…æ–¯">ä¿„ç¾…æ–¯</option>
          <option value="ç¾åœ‹">ç¾åœ‹</option>
          <option value="åŠ æ‹¿å¤§">åŠ æ‹¿å¤§</option>
          <option value="å¢¨è¥¿å“¥">å¢¨è¥¿å“¥</option>
          <option value="ç“œåœ°é¦¬æ‹‰">ç“œåœ°é¦¬æ‹‰</option>
          <option value="è²é‡Œæ–¯">è²é‡Œæ–¯</option>
          <option value="å®éƒ½æ‹‰æ–¯">å®éƒ½æ‹‰æ–¯</option>
          <option value="è–©çˆ¾ç“¦å¤š">è–©çˆ¾ç“¦å¤š</option>
          <option value="å°¼åŠ æ‹‰ç“œ">å°¼åŠ æ‹‰ç“œ</option>
          <option value="å“¥æ–¯å¤§é»åŠ ">å“¥æ–¯å¤§é»åŠ </option>
          <option value="å·´æ‹¿é¦¬">å·´æ‹¿é¦¬</option>
          <option value="å¤å·´">å¤å·´</option>
          <option value="ç‰™è²·åŠ ">ç‰™è²·åŠ </option>
          <option value="æµ·åœ°">æµ·åœ°</option>
          <option value="å¤šæ˜å°¼åŠ ">å¤šæ˜å°¼åŠ </option>
          <option value="æ³¢å¤šé»å„">æ³¢å¤šé»å„</option>
          <option value="å·´å“ˆé¦¬">å·´å“ˆé¦¬</option>
          <option value="å·´è²å¤š">å·´è²å¤š</option>
          <option value="åƒé‡Œé”åŠæ‰˜å·´å“¥">åƒé‡Œé”åŠæ‰˜å·´å“¥</option>
          <option value="å·´è¥¿">å·´è¥¿</option>
          <option value="é˜¿æ ¹å»·">é˜¿æ ¹å»·</option>
          <option value="æ™ºåˆ©">æ™ºåˆ©</option>
          <option value="ç§˜é­¯">ç§˜é­¯</option>
          <option value="å“¥å€«æ¯”äº">å“¥å€«æ¯”äº</option>
          <option value="å§”å…§ç‘æ‹‰">å§”å…§ç‘æ‹‰</option>
          <option value="å„ç“œå¤š">å„ç“œå¤š</option>
          <option value="ç»åˆ©ç¶­äº">ç»åˆ©ç¶­äº</option>
          <option value="å·´æ‹‰åœ­">å·´æ‹‰åœ­</option>
          <option value="çƒæ‹‰åœ­">çƒæ‹‰åœ­</option>
          <option value="è“‹äºé‚£">è“‹äºé‚£</option>
          <option value="è˜‡åˆ©å—">è˜‡åˆ©å—</option>
          <option value="æ¾³æ´²">æ¾³æ´²</option>
          <option value="ç´è¥¿è˜­">ç´è¥¿è˜­</option>
          <option value="æ–æ¿Ÿ">æ–æ¿Ÿ</option>
          <option value="å·´å¸ƒäºç´å¹¾å…§äº">å·´å¸ƒäºç´å¹¾å…§äº</option>
          <option value="è¬é‚£æœ">è¬é‚£æœ</option>
          <option value="ç´¢ç¾…é–€ç¾¤å³¶">ç´¢ç¾…é–€ç¾¤å³¶</option>
          <option value="è–©æ‘©äº">è–©æ‘©äº</option>
          <option value="æ±åŠ ">æ±åŠ </option>
          <option value="åŸƒåŠ">åŸƒåŠ</option>
          <option value="åˆ©æ¯”äº">åˆ©æ¯”äº</option>
          <option value="çªå°¼è¥¿äº">çªå°¼è¥¿äº</option>
          <option value="é˜¿çˆ¾åŠåˆ©äº">é˜¿çˆ¾åŠåˆ©äº</option>
          <option value="æ‘©æ´›å“¥">æ‘©æ´›å“¥</option>
          <option value="è˜‡ä¸¹">è˜‡ä¸¹</option>
          <option value="å—è˜‡ä¸¹">å—è˜‡ä¸¹</option>
          <option value="è¡£ç´¢æ¯”äº">è¡£ç´¢æ¯”äº</option>
          <option value="è‚¯äº">è‚¯äº</option>
          <option value="å¦å°šå°¼äº">å¦å°šå°¼äº</option>
          <option value="çƒå¹²é”">çƒå¹²é”</option>
          <option value="ç›§å®‰é”">ç›§å®‰é”</option>
          <option value="è’²éš†åœ°">è’²éš†åœ°</option>
          <option value="ç´¢é¦¬åˆ©äº">ç´¢é¦¬åˆ©äº</option>
          <option value="é¦¬é”åŠ æ–¯åŠ ">é¦¬é”åŠ æ–¯åŠ </option>
          <option value="è«ä¸‰æ¯”å…‹">è«ä¸‰æ¯”å…‹</option>
          <option value="å°šæ¯”äº">å°šæ¯”äº</option>
          <option value="è¾›å·´å¨">è¾›å·´å¨</option>
          <option value="é¦¬æ‹‰å¨">é¦¬æ‹‰å¨</option>
          <option value="å¥ˆåŠåˆ©äº">å¥ˆåŠåˆ©äº</option>
          <option value="è¿¦ç´">è¿¦ç´</option>
          <option value="å¡å…§åŠ çˆ¾">å¡å…§åŠ çˆ¾</option>
          <option value="è±¡ç‰™æµ·å²¸">è±¡ç‰™æµ·å²¸</option>
          <option value="å–€éº¥éš†">å–€éº¥éš†</option>
          <option value="é¦¬åˆ©">é¦¬åˆ©</option>
          <option value="å¸ƒå‰ç´æ³•ç´¢">å¸ƒå‰ç´æ³•ç´¢</option>
          <option value="å¹¾å…§äº">å¹¾å…§äº</option>
          <option value="è²å—">è²å—</option>
          <option value="å¤šå“¥">å¤šå“¥</option>
          <option value="å°¼æ—¥">å°¼æ—¥</option>
          <option value="æŸ¥å¾·">æŸ¥å¾·</option>
          <option value="èŒ…åˆ©å¡”å°¼äº">èŒ…åˆ©å¡”å°¼äº</option>
          <option value="å—é">å—é</option>
          <option value="ç´ç±³æ¯”äº">ç´ç±³æ¯”äº</option>
          <option value="æ³¢æ‰é‚£">æ³¢æ‰é‚£</option>
          <option value="è³´ç´¢æ‰˜">è³´ç´¢æ‰˜</option>
          <option value="å²ç“¦å¸å°¼">å²ç“¦å¸å°¼</option>
          <option value="å‰›æœæ°‘ä¸»å…±å’Œåœ‹">å‰›æœæ°‘ä¸»å…±å’Œåœ‹</option>
          <option value="å‰›æœå…±å’Œåœ‹">å‰›æœå…±å’Œåœ‹</option>
          <option value="å®‰å“¥æ‹‰">å®‰å“¥æ‹‰</option>
          <option value="åŠ å½­">åŠ å½­</option>
          <option value="èµ¤é“å¹¾å…§äº">èµ¤é“å¹¾å…§äº</option>
          <option value="ä¸­éå…±å’Œåœ‹">ä¸­éå…±å’Œåœ‹</option>
        </select>
        <input type="text" class="form-input" id="f-city" placeholder="åŸå¸‚ï¼ˆé¸å¡«ï¼‰">
        <input type="text" class="form-input" id="f-store" placeholder="åº—åï¼ˆé¸å¡«ï¼‰">
      </div>
    </div>

    <!-- Date -->
    <div class="form-section">
      <label class="form-label">æ—¥æœŸ</label>
      <input type="date" class="form-input" id="f-date">
    </div>

    <!-- Price + currency -->
    <div class="form-section">
      <label class="form-label">æ¡è³¼åƒ¹æ ¼ / å¹£åˆ¥</label>
      <div class="form-row">
        <div class="price-wrap">
          <input type="number" class="form-input" id="f-price" placeholder="é¸å¡«" oninput="updateTwdHint()">
          <span class="price-hint" id="twd-hint"></span>
        </div>
        <select class="form-select" id="f-currency" onchange="updateTwdHint()">
          <option value="">å¹£åˆ¥</option>
          <option value="EUR">EUR</option>
          <option value="RMB">RMB</option>
          <option value="TWD">TWD</option>
        </select>
      </div>
    </div>

    <!-- Discount -->
    <div class="form-section">
      <label class="form-label">æŠ˜æ‰£</label>
      <label class="discount-toggle">
        <input type="checkbox" id="f-has-discount" onchange="toggleDiscount()">
        <span class="discount-dot"></span>
        <span class="discount-label">æœ‰æŠ˜æ‰£ / ç¾é‡‘åƒ¹</span>
      </label>
      <div id="discount-fields" style="display:none;margin-top:10px">
        <div class="form-row">
          <div class="price-wrap">
            <input type="number" class="form-input" id="f-discount-price" placeholder="æŠ˜æ‰£å¾Œæ¡è³¼åƒ¹" oninput="updateDiscountHint()">
            <span class="price-hint" id="discount-hint"></span>
          </div>
          <input type="text" class="form-input" id="f-discount-note" placeholder="æŠ˜æ‰£å‚™è¨»">
        </div>
      </div>
    </div>

    <div class="form-section">
      <label class="form-label" id="shipping-label">é‹è²»ï¼ˆé¸å¡«ï¼‰</label>
      <div class="form-row" style="align-items:center">
        <div class="price-wrap">
          <input type="number" class="form-input" id="f-shipping" placeholder="é‹è²»ï¼ˆé¸å¡«ï¼‰" oninput="updateMargin()">
          <span class="price-hint" id="shipping-hint"></span>
        </div>
        <label class="discount-toggle" style="white-space:nowrap">
          <input type="checkbox" id="f-shipping-in-cost" onchange="updateMargin()">
          <span class="discount-dot"></span>
          <span class="discount-label">è¨ˆå…¥æˆæœ¬</span>
        </label>
      </div>
    </div>

    <!-- Business fields -->
    <div class="form-section">
      <label class="form-label" id="sell-price-label">æ•¸é‡ / å”®åƒ¹</label>
      <div class="form-row">
        <input type="number" class="form-input" id="f-qty" placeholder="æ•¸é‡ï¼ˆé¸å¡«ï¼‰" min="1" oninput="updateMargin()">
        <div class="price-wrap">
          <input type="number" class="form-input" id="f-sell-price" placeholder="å”®åƒ¹ï¼ˆé¸å¡«ï¼‰" oninput="updateMargin()">
          <span class="price-hint" id="sell-hint"></span>
        </div>
        <select class="form-select" id="f-sell-currency" onchange="updateMargin()" style="max-width:80px">
          <option value="">å¹£åˆ¥</option>
          <option value="EUR">EUR</option>
          <option value="RMB">RMB</option>
          <option value="TWD">TWD</option>
        </select>
      </div>
      <div id="margin-hint" class="calc-hint" style="margin-top:6px"></div>
    </div>

    <!-- Category -->
    <div class="form-section">
      <label class="form-label">åˆ†é¡</label>
      <div class="toggle-group" id="cat-group">
        <button class="toggle-btn" onclick="selectToggle('cat-group', this, 'f-category')">çš®ä»¶</button>
        <button class="toggle-btn" onclick="selectToggle('cat-group', this, 'f-category')">é£¾å“</button>
        <button class="toggle-btn" onclick="selectToggle('cat-group', this, 'f-category')">æœé£¾</button>
        <button class="toggle-btn" onclick="selectToggle('cat-group', this, 'f-category')">å¨ƒå¨ƒ</button>
        <button class="toggle-btn" onclick="selectToggle('cat-group', this, 'f-category')">åŒ–å¦å“</button>
        <button class="toggle-btn" onclick="selectToggle('cat-group', this, 'f-category')">ç²¾å“</button>
        <button class="toggle-btn" onclick="selectToggle('cat-group', this, 'f-category')">æ­æ ¹ç´—è¢‹</button>
        <button class="toggle-btn" onclick="selectToggle('cat-group', this, 'f-category')">å…¶ä»–</button>
      </div>
      <input type="hidden" id="f-category">
    </div>

    <!-- Type -->
    <div class="form-section">
      <label class="form-label">ç”¨é€”</label>
      <div class="toggle-group" id="type-group">
        <button class="toggle-btn" onclick="selectToggle('type-group', this, 'f-type')">æ¥­å‹™</button>
        <button class="toggle-btn" onclick="selectToggle('type-group', this, 'f-type')">ç§äºº</button>
      </div>
      <input type="hidden" id="f-type">
    </div>

    <!-- Mode: catalog or record -->
    <div class="form-section">
      <label class="form-label">è¨˜éŒ„æ¨¡å¼</label>
      <div class="toggle-group" id="mode-group">
        <button class="toggle-btn active" onclick="selectToggle('mode-group', this, 'f-mode')">æ¡è³¼ç´€éŒ„</button>
        <button class="toggle-btn" onclick="selectToggle('mode-group', this, 'f-mode')">æš«å­˜ç›®éŒ„</button>
      </div>
      <input type="hidden" id="f-mode" value="æ¡è³¼ç´€éŒ„">
    </div>

    <!-- Note -->
    <div class="form-section">
      <label class="form-label">å‚™è¨»</label>
      <textarea class="form-textarea" id="f-note" placeholder="è©•åƒ¹æˆ–å‚™æ³¨..."></textarea>
    </div>

    <input type="hidden" id="f-edit-id">
    <button class="btn-save" onclick="saveRecord()">å„² å­˜</button>
  </div>
</div>

<!-- Batch currency modal -->
<div class="modal-overlay" id="batch-currency-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">æ‰¹æ¬¡ä¿®æ”¹å¹£åˆ¥</div>
      <button class="modal-close" onclick="closeModal('batch-currency-modal')">âœ•</button>
    </div>
    <p style="font-size:12px;color:var(--light);letter-spacing:1.5px;margin-bottom:14px">é¸æ“‡æœªå¡«å¹£åˆ¥çš„ç´€éŒ„ï¼Œçµ±ä¸€è¨­å®š</p>
    <div id="batch-list"></div>
    <div style="margin-top:14px">
      <label class="form-label">å¥—ç”¨å¹£åˆ¥</label>
      <select class="form-select" id="batch-currency">
        <option value="EUR">EUR</option>
        <option value="RMB">RMB</option>
        <option value="TWD">TWD</option>
      </select>
    </div>
    <button class="btn-save" style="margin-top:14px" onclick="applyBatchCurrency()">å¥— ç”¨ é¸ å–</button>
  </div>
</div>

<!-- Batch status modal -->
<div class="modal-overlay" id="batch-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">ä»Šæ—¥æ¨™è¨˜</div>
      <button class="modal-close" onclick="closeModal('batch-modal')">âœ•</button>
    </div>
    <div id="batch-status-list"></div>
    <button class="btn-save" style="margin-top:14px" onclick="saveBatchStatus()">å„² å­˜</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â”€â”€ IndexedDB setup â”€â”€
const DB_NAME = 'shopping-journal';
const DB_VERSION = 1;
let db = null;

function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = e => {
      const d = e.target.result;
      if (!d.objectStoreNames.contains('records')) {
        d.createObjectStore('records', { keyPath: 'id' });
      }
      if (!d.objectStoreNames.contains('photos')) {
        d.createObjectStore('photos', { keyPath: 'id' });
      }
      if (!d.objectStoreNames.contains('settings')) {
        d.createObjectStore('settings', { keyPath: 'key' });
      }
    };
    req.onsuccess = e => { db = e.target.result; resolve(db); };
    req.onerror = () => reject(req.error);
  });
}

function dbPut(store, value) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(store, 'readwrite');
    const req = tx.objectStore(store).put(value);
    req.onsuccess = () => resolve();
    req.onerror = () => reject(req.error);
  });
}

function dbGet(store, key) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(store, 'readonly');
    const req = tx.objectStore(store).get(key);
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

function dbGetAll(store) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(store, 'readonly');
    const req = tx.objectStore(store).getAll();
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

function dbDelete(store, key) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(store, 'readwrite');
    const req = tx.objectStore(store).delete(key);
    req.onsuccess = () => resolve();
    req.onerror = () => reject(req.error);
  });
}

function dbClear(store) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(store, 'readwrite');
    const req = tx.objectStore(store).clear();
    req.onsuccess = () => resolve();
    req.onerror = () => reject(req.error);
  });
}

// â”€â”€ App state â”€â”€
let records = [];
let rates = { EUR: 35, RMB: 4.5, TWD: 1 };
let currentFilter = 'all';
let photoData = null;
let photoBlob = null;
let batchSelections = {};
let sortDirs = { records: 'desc', catalog: 'desc' };

async function saveData() {
  // Save all records (without photo) to IndexedDB records store
  for (const r of records) {
    const recNoPhoto = { ...r };
    delete recNoPhoto.photo; // don't store photo in records store
    await dbPut('records', recNoPhoto);
  }
}

async function saveRecord_db(rec, blob) {
  const recNoPhoto = { ...rec };
  delete recNoPhoto.photo;
  await dbPut('records', recNoPhoto);
  if (blob) {
    await dbPut('photos', { id: rec.id, blob });
  }
}

async function deleteRecord_db(id) {
  await dbDelete('records', id);
  await dbDelete('photos', id);
}

async function loadAllRecords() {
  const recs = await dbGetAll('records');
  const photos = await dbGetAll('photos');
  const photoMap = {};
  photos.forEach(p => {
    photoMap[p.id] = URL.createObjectURL(p.blob);
  });
  records = recs.map(r => ({ ...r, photo: photoMap[r.id] || null }));
  // sort newest first
  records.sort((a, b) => (b.id > a.id ? 1 : -1));
}

async function saveRates() {
  rates.EUR = parseFloat(document.getElementById('rate-EUR').value) || 35;
  rates.RMB = parseFloat(document.getElementById('rate-RMB').value) || 4.5;
  rates.TWD = 1;
  await dbPut('settings', { key: 'rates', value: rates });
  renderRecords();
  toast('åŒ¯ç‡å·²æ›´æ–°');
}

async function loadRates() {
  const stored = await dbGet('settings', 'rates');
  if (stored) rates = stored.value;
  document.getElementById('rate-EUR').value = rates.EUR;
  document.getElementById('rate-RMB').value = rates.RMB;
}

function loadRateInputs() {
  document.getElementById('rate-EUR').value = rates.EUR;
  document.getElementById('rate-RMB').value = rates.RMB;
}

function switchTab(tab) {
  document.querySelectorAll('.tab').forEach((t, i) => {
    const tabs = ['records','catalog','summary','settings'];
    t.classList.toggle('active', tabs[i] === tab);
  });
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + tab).classList.add('active');
  if (tab === 'summary') renderSummary();
  if (tab === 'catalog') renderCatalog();
  if (tab === 'records') renderRecords();
}

function openAddModal(editId = null) {
  clearForm();
  if (editId) {
    const rec = records.find(r => r.id === editId);
    if (!rec) return;
    document.getElementById('modal-title-text').textContent = 'ç·¨è¼¯ç´€éŒ„';
    document.getElementById('f-edit-id').value = editId;
    document.getElementById('f-name').value = rec.name || '';
    document.getElementById('f-price').value = rec.price || '';
    document.getElementById('f-currency').value = rec.currency || '';
    document.getElementById('f-country').value = rec.country || '';
    document.getElementById('f-city').value = rec.city || '';
    document.getElementById('f-store').value = rec.store || '';
    document.getElementById('f-category').value = rec.category || '';
    document.getElementById('f-type').value = rec.type || '';
    document.getElementById('f-mode').value = rec.mode || 'æ¡è³¼ç´€éŒ„';
    document.getElementById('f-note').value = rec.note || '';
    document.getElementById('f-qty').value = rec.qty || '';
    document.getElementById('f-sell-price').value = rec.sellPrice || '';
    document.getElementById('f-sell-currency').value = rec.sellCurrency || '';
    document.getElementById('f-shipping').value = rec.shipping || '';
    document.getElementById('f-shipping-in-cost').checked = rec.shippingInCost || false;
    // Set date - convert zh-TW format back to input[type=date] format if needed
    if (rec.date) {
      // Try to parse zh-TW date like 114/5/20 or standard yyyy/mm/dd
      let d = rec.date.replace(/\//g, '-');
      // If year < 1000 it's ROC calendar, convert to AD
      const parts = d.split('-');
      if (parts.length === 3 && parseInt(parts[0]) < 200) {
        d = (parseInt(parts[0]) + 1911) + '-' + parts[1].padStart(2,'0') + '-' + parts[2].padStart(2,'0');
      }
      document.getElementById('f-date').value = d;
    } else {
      document.getElementById('f-date').value = new Date().toISOString().split('T')[0];
    }
    if (rec.hasDiscount) {
      document.getElementById('f-has-discount').checked = true;
      document.getElementById('discount-fields').style.display = 'block';
      document.getElementById('f-discount-price').value = rec.discountPrice || '';
      document.getElementById('f-discount-note').value = rec.discountNote || '';
    }
    if (rec.photo) {
      document.getElementById('photo-preview').src = rec.photo;
      document.getElementById('photo-preview').style.display = 'block';
      document.getElementById('photo-placeholder').style.display = 'none';
      photoData = rec.photo;
      photoBlob = null; // already saved, no new blob
    }
    restoreToggle('cat-group', rec.category);
    restoreToggle('type-group', rec.type);
    restoreToggle('mode-group', rec.mode);
    updateTwdHint();
  } else {
    document.getElementById('modal-title-text').textContent = 'æ–°å¢ç´€éŒ„';
    document.querySelector('#mode-group .toggle-btn').classList.add('active');
    document.getElementById('f-country').value = '';
  document.getElementById('f-mode').value = 'æ¡è³¼ç´€éŒ„';
  document.getElementById('f-shipping-in-cost').checked = false;
  document.getElementById('f-date').value = new Date().toISOString().split('T')[0];
  }
  document.getElementById('add-modal').classList.add('open');
}

function restoreToggle(groupId, value) {
  if (!value) return;
  const btns = document.querySelectorAll('#' + groupId + ' .toggle-btn');
  btns.forEach(b => {
    b.classList.toggle('active', b.textContent === value);
  });
}

function clearForm() {
  ['f-name','f-price','f-currency','f-city','f-store','f-category','f-type','f-note','f-edit-id','f-discount-price','f-discount-note','f-qty','f-sell-price','f-shipping','f-date'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  document.getElementById('f-mode').value = 'æ¡è³¼ç´€éŒ„';
  document.getElementById('f-has-discount').checked = false;
  document.getElementById('discount-fields').style.display = 'none';
  document.getElementById('photo-preview').style.display = 'none';
  document.getElementById('photo-preview').style.display = 'none';
  document.getElementById('photo-placeholder').style.display = 'block';
  document.getElementById('twd-hint').textContent = '';
  document.getElementById('discount-hint').textContent = '';
  photoData = null;
  photoBlob = null;
  document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
}

function closeModal(id) {
  document.getElementById(id).classList.remove('open');
}

function handlePhoto(event) {
  const file = event.target.files[0];
  if (!file) return;
  photoBlob = file; // save raw blob for IndexedDB
  const url = URL.createObjectURL(file);
  photoData = url;
  document.getElementById('photo-preview').src = url;
  document.getElementById('photo-preview').style.display = 'block';
  document.getElementById('photo-placeholder').style.display = 'none';
}

function selectToggle(groupId, btn, hiddenId) {
  const group = document.getElementById(groupId);
  group.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById(hiddenId).value = btn.textContent;
}

function toggleDiscount() {
  const checked = document.getElementById('f-has-discount').checked;
  document.getElementById('discount-fields').style.display = checked ? 'block' : 'none';
}

function toTWD(price, currency) {
  if (!price || !currency || !rates[currency]) return null;
  return Math.round(parseFloat(price) * rates[currency]);
}

function updateTwdHint() {
  const price = document.getElementById('f-price').value;
  const cur = document.getElementById('f-currency').value;
  const twd = toTWD(price, cur);
  document.getElementById('twd-hint').textContent = twd && cur !== 'TWD' ? `â‰ˆ TWD ${twd.toLocaleString()}` : '';
  // Update labels and hints when buy currency changes
  const curLabel = cur || 'TWD';
  const shipLabel = document.getElementById('shipping-label');
  if (shipLabel) shipLabel.textContent = `é‹è²» ${curLabel}ï¼ˆé¸å¡«ï¼‰`;
  const shipInput = document.getElementById('f-shipping');
  if (shipInput) shipInput.placeholder = `é‹è²»ï¼ˆ${curLabel}ï¼Œé¸å¡«ï¼‰`;
  updateMargin();
}

function updateDiscountHint() {
  const price = document.getElementById('f-discount-price').value;
  const cur = document.getElementById('f-currency').value;
  const twd = toTWD(price, cur);
  document.getElementById('discount-hint').textContent = twd && cur !== 'TWD' ? `â‰ˆ TWD ${twd.toLocaleString()}` : '';
}

function calcMargin(r) {
  if (!r.price || !r.sellPrice) return null;
  const qty = parseFloat(r.qty) || 1;
  const buyRate = rates[r.currency] || 1;
  const sellRate = rates[r.sellCurrency] || 1;
  const costTWD = parseFloat(r.price) * buyRate;
  const shippingTWD = r.shippingInCost ? (parseFloat(r.shipping) || 0) * buyRate / qty : 0;
  const costPerUnitTWD = costTWD + shippingTWD;
  const sellPerUnitTWD = parseFloat(r.sellPrice) * sellRate;
  if (sellPerUnitTWD === 0) return null;
  return Math.round((sellPerUnitTWD - costPerUnitTWD) / sellPerUnitTWD * 100);
}

function calcDiscountMargin(r) {
  if (!r.discountPrice || !r.hasDiscount || !r.sellPrice) return null;
  const qty = parseFloat(r.qty) || 1;
  const buyRate = rates[r.currency] || 1;
  const sellRate = rates[r.sellCurrency] || 1;
  const discCostTWD = parseFloat(r.discountPrice) * buyRate;
  const shippingTWD = r.shippingInCost ? (parseFloat(r.shipping) || 0) * buyRate / qty : 0;
  const costPerUnitTWD = discCostTWD + shippingTWD;
  const sellPerUnitTWD = parseFloat(r.sellPrice) * sellRate;
  if (sellPerUnitTWD === 0) return null;
  return Math.round((sellPerUnitTWD - costPerUnitTWD) / sellPerUnitTWD * 100);
}

function calcMarginTWD(r) {
  // Returns profit in TWD for summary
  if (!r.price || !r.currency || !r.sellPrice) return null;
  const qty = parseFloat(r.qty) || 1;
  const costTWD = toTWD(r.price, r.currency) * qty;
  const shippingCost = r.shippingInCost ? (parseFloat(r.shipping) || 0) * rates[r.currency] : 0;
  const sellTWD = toTWD(r.sellPrice, r.currency) * qty;
  return sellTWD - costTWD - shippingCost;
}

function updateMargin() {
  const buyCur = document.getElementById('f-currency').value;
  const sellCur = document.getElementById('f-sell-currency').value;
  const price = parseFloat(document.getElementById('f-price').value);
  const qty = parseFloat(document.getElementById('f-qty').value) || 1;
  const sellPrice = parseFloat(document.getElementById('f-sell-price').value);
  const shipping = parseFloat(document.getElementById('f-shipping').value) || 0;
  const shippingInCost = document.getElementById('f-shipping-in-cost').checked;
  const hasDiscount = document.getElementById('f-has-discount').checked;
  const discountPrice = parseFloat(document.getElementById('f-discount-price').value);
  const hint = document.getElementById('margin-hint');

  // Update TWD hints for shipping and sell price
  const shippingEl = document.getElementById('shipping-hint');
  const sellEl = document.getElementById('sell-hint');
  if (shippingEl) {
    const shippingTwd = shipping && buyCur && buyCur !== 'TWD' ? Math.round(shipping * (rates[buyCur] || 1)) : null;
    shippingEl.textContent = shippingTwd ? `â‰ˆ TWD ${shippingTwd.toLocaleString()}` : '';
  }
  if (sellEl) {
    const sellTwd = sellPrice && sellCur && sellCur !== 'TWD' ? Math.round(sellPrice * (rates[sellCur] || 1)) : null;
    sellEl.textContent = sellTwd ? `â‰ˆ TWD ${sellTwd.toLocaleString()}` : '';
  }

  if (!price || !sellPrice) { hint.innerHTML = ''; return; }

  // Convert everything to TWD for cross-currency comparison
  const buyRate = rates[buyCur] || 1;
  const sellRate = rates[sellCur] || 1;
  const shippingRate = rates[buyCur] || 1; // shipping in buy currency

  const costTWD = price * buyRate;
  const shippingTWD = shippingInCost ? (shipping / qty) * shippingRate : 0;
  const costPerUnitTWD = costTWD + shippingTWD;
  const sellPerUnitTWD = sellPrice * sellRate;

  function marginLine(costTWDper, sellTWDper, buyCurLabel, sellCurLabel, label) {
    if (!sellTWDper) return '';
    const m = Math.round((sellTWDper - costTWDper) / sellTWDper * 100);
    const profitPerUnit = sellTWDper - costTWDper;
    const profitTotal = profitPerUnit * qty;
    const cls = m >= 0 ? 'margin-positive' : 'margin-negative';
    const sameRate = buyRate === sellRate;
    return `<div style="margin-top:4px;line-height:1.6">`
      + `${label}<span class="${cls}"><strong>${m}%</strong></span>`
      + `<span style="opacity:0.6;font-size:11px"> /ä»¶</span>`
      + `ã€€ç²åˆ© TWD ${profitTotal.toLocaleString()}`
      + `<br><span style="opacity:0.65;font-size:11px">`
      + `æˆæœ¬ ${costTWDper.toFixed(0)} TWDï¼ä»¶ â†’ å”® ${sellTWDper.toFixed(0)} TWDï¼ä»¶`
      + `</span></div>`;
  }

  let html = marginLine(costPerUnitTWD, sellPerUnitTWD, buyCur, sellCur, 'åŸåƒ¹æ¯›åˆ©ã€€');
  if (hasDiscount && discountPrice) {
    const discCostTWD = discountPrice * buyRate + shippingTWD;
    html += marginLine(discCostTWD, sellPerUnitTWD, buyCur, sellCur, 'æŠ˜å¾Œæ¯›åˆ©ã€€');
  }

  hint.className = 'calc-hint';
  hint.innerHTML = html;
}

async function saveRecord() {
  const editId = document.getElementById('f-edit-id').value;
  const mode = document.getElementById('f-mode').value || 'æ¡è³¼ç´€éŒ„';
  const id = editId || Date.now().toString();
  const existingRec = editId ? records.find(r => r.id === editId) : null;

  const rec = {
    id,
    name: document.getElementById('f-name').value,
    price: document.getElementById('f-price').value,
    currency: document.getElementById('f-currency').value,
    country: document.getElementById('f-country').value,
    city: document.getElementById('f-city').value,
    store: document.getElementById('f-store').value,
    category: document.getElementById('f-category').value,
    type: document.getElementById('f-type').value,
    mode,
    note: document.getElementById('f-note').value,
    qty: document.getElementById('f-qty').value,
    sellPrice: document.getElementById('f-sell-price').value,
    sellCurrency: document.getElementById('f-sell-currency').value,
    shipping: document.getElementById('f-shipping').value,
    shippingInCost: document.getElementById('f-shipping-in-cost').checked,
    hasDiscount: document.getElementById('f-has-discount').checked,
    discountPrice: document.getElementById('f-discount-price').value,
    discountNote: document.getElementById('f-discount-note').value,
    photo: photoData || (existingRec ? existingRec.photo : null),
    status: existingRec ? (existingRec.status || '') : '',
    date: document.getElementById('f-date').value || new Date().toLocaleDateString('zh-TW'),
  };

  // Save to IndexedDB
  await saveRecord_db(rec, photoBlob);

  if (editId) {
    const idx = records.findIndex(r => r.id === editId);
    records[idx] = rec;
  } else {
    records.unshift(rec);
  }

  closeModal('add-modal');
  renderRecords();
  renderCatalog();
  toast('å·²å„²å­˜');
}

function renderRecords() {
  const list = document.getElementById('record-list');
  let filtered = records.filter(r => r.mode !== 'æš«å­˜ç›®éŒ„');
  if (currentFilter === 'buy') filtered = filtered.filter(r => r.status === 'buy');
  else if (currentFilter === 'bought') filtered = filtered.filter(r => r.status === 'bought');
  else if (currentFilter === 'pass') filtered = filtered.filter(r => r.status === 'pass');
  else if (currentFilter === 'biz') filtered = filtered.filter(r => r.type === 'æ¥­å‹™');
  else if (currentFilter === 'personal') filtered = filtered.filter(r => r.type === 'ç§äºº');

  const cityVal = document.getElementById('filter-city')?.value || '';
  const countryVal = document.getElementById('filter-country')?.value || '';
  const storeVal = document.getElementById('filter-store')?.value || '';
  if (cityVal) filtered = filtered.filter(r => r.city === cityVal);
  if (countryVal) filtered = filtered.filter(r => (r.country || '') === countryVal);
  if (storeVal) filtered = filtered.filter(r => (r.store || '') === storeVal);

  filtered = applySort(filtered, 'records');
  populateFilterDropdowns();

  if (!filtered.length) {
    list.innerHTML = `<div class="empty-state"><div class="empty-icon">âœ¦</div><div class="empty-text">æš«ç„¡ç´€éŒ„</div></div>`;
    return;
  }
  list.innerHTML = filtered.map(r => recordCardHTML(r)).join('');
}

function renderCatalog() {
  const list = document.getElementById('catalog-list');
  let items = records.filter(r => r.mode === 'æš«å­˜ç›®éŒ„');

  const cityVal = document.getElementById('filter-city-cat')?.value || '';
  const countryVal = document.getElementById('filter-country-cat')?.value || '';
  const storeVal = document.getElementById('filter-store-cat')?.value || '';
  if (cityVal) items = items.filter(r => r.city === cityVal);
  if (countryVal) items = items.filter(r => (r.country || '') === countryVal);
  if (storeVal) items = items.filter(r => (r.store || '') === storeVal);

  items = applySort(items, 'catalog');
  populateFilterDropdowns();

  if (!items.length) {
    list.innerHTML = `<div class="empty-state"><div class="empty-icon">â—‡</div><div class="empty-text">è©¢åƒ¹å•†å“æš«å­˜æ–¼æ­¤</div></div>`;
    return;
  }
  list.innerHTML = items.map(r => recordCardHTML(r, true)).join('');
}

function recordCardHTML(r, isCatalog = false) {
  const twd = toTWD(r.price, r.currency);
  const cur = r.currency || '';
  const sellCur = r.sellCurrency || cur;
  const twdStr = twd && cur !== 'TWD' ? ` <span class="record-price-twd">â‰ˆ TWD ${twd.toLocaleString()}</span>` : '';
  const discTwd = r.hasDiscount && r.discountPrice && cur !== 'TWD'
    ? Math.round(parseFloat(r.discountPrice) * (rates[cur] || 1)) : null;
  const discStr = r.hasDiscount && r.discountPrice
    ? ` <span style="opacity:0.5;font-size:11px">â†’ æŠ˜</span> <span style="color:var(--gold)">${r.discountPrice} ${cur}${discTwd ? ` <span class="record-price-twd">â‰ˆ TWD ${discTwd.toLocaleString()}</span>` : ''}</span>`
    : '';
  const priceStr = r.price ? `<span style="opacity:0.55;font-size:11px">è²·</span> ${r.price} ${cur}${twdStr}${discStr}` : 'â€”';
  const margin = calcMargin(r);
  const discMargin = calcDiscountMargin(r);

  const thumb = r.photo
    ? `<div class="thumb-wrap"><div class="record-thumb"><img src="${r.photo}"></div></div>`
    : `<div class="thumb-wrap"><div class="record-thumb">â—»</div></div>`;

  const inlineStatus = !isCatalog ? `
    <div class="card-status-row">
      <button class="status-btn s-buy ${r.status==='buy'?'active':''}" onclick="setStatus('${r.id}','buy',this)">è¦è²·</button>
      <button class="status-btn s-bought ${r.status==='bought'?'active':''}" onclick="setStatus('${r.id}','bought',this)">å·²è²·</button>
      <button class="status-btn s-pass ${r.status==='pass'?'active':''}" onclick="setStatus('${r.id}','pass',this)">æ”¾æ£„</button>
    </div>` : '';

  const bizLine = r.qty ? `
    <div class="record-biz-line">
      <span>Ã—${r.qty} ä»¶</span>
    </div>` : '';

  return `<div class="record-card" id="card-${r.id}">
    <div class="record-top">
      ${thumb}
      <div class="record-body">
        <div class="record-name">${r.name || 'ï¼ˆæœªå‘½åï¼‰'}</div>
        <div class="record-meta">${[r.country, r.city, r.store].filter(Boolean).join(' Â· ') || ''}${r.date ? ' Â· ' + r.date : ''}</div>
        <div class="record-price">${priceStr}</div>
        ${bizLine}
        ${inlineStatus}
      </div>
    </div>
    <div class="record-tags">
      ${r.category ? `<span class="tag tag-cat">${r.category}</span>` : ''}
      ${r.type === 'æ¥­å‹™' ? `<span class="tag tag-biz">æ¥­å‹™</span>` : r.type === 'ç§äºº' ? `<span class="tag tag-personal">ç§äºº</span>` : ''}
      ${r.hasDiscount ? `<span class="tag tag-discount">æŠ˜æ‰£${r.discountPrice ? ' ' + r.discountPrice + (r.currency ? ' ' + r.currency : '') : ''}</span>` : ''}
      ${r.note ? `<span class="tag tag-note">${r.note}</span>` : ''}
      ${isCatalog ? `<span class="tag tag-catalog">ç›®éŒ„</span>` : ''}
    </div>
    <div class="record-bottom">
      ${isCatalog ? `
        <button class="rec-btn catalog-convert-btn" onclick="convertCatalog('${r.id}')">â†’ æ¡è³¼</button>
        <button class="rec-btn danger" onclick="deleteRecord('${r.id}')">åˆª</button>` : ''}
      <div class="record-action-btns" style="${isCatalog?'':'margin-left:auto'}">
        <button class="rec-btn" onclick="openAddModal('${r.id}')">ç·¨è¼¯</button>
        ${!isCatalog ? `<button class="rec-btn danger" onclick="deleteRecord('${r.id}')">åˆª</button>` : ''}
      </div>
    </div>
  </div>`;
}

async function setStatus(id, status, btn) {
  const rec = records.find(r => r.id === id);
  if (!rec) return;
  rec.status = rec.status === status ? '' : status;
  const recNoPhoto = { ...rec }; delete recNoPhoto.photo;
  await dbPut('records', recNoPhoto);
  const card = document.getElementById('card-' + id);
  if (card) {
    card.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active'));
    if (rec.status) card.querySelector('.s-' + rec.status)?.classList.add('active');
  }
}

async function deleteRecord(id) {
  records = records.filter(r => r.id !== id);
  await deleteRecord_db(id);
  renderRecords();
  renderCatalog();
  toast('å·²åˆªé™¤');
}

async function convertCatalog(id) {
  const rec = records.find(r => r.id === id);
  if (!rec) return;
  rec.mode = 'æ¡è³¼ç´€éŒ„';
  const recNoPhoto = { ...rec }; delete recNoPhoto.photo;
  await dbPut('records', recNoPhoto);
  renderCatalog();
  renderRecords();
  toast('å·²ç§»è‡³æ¡è³¼ç´€éŒ„');
}

function toggleSortDir(page) {
  sortDirs[page] = sortDirs[page] === 'desc' ? 'asc' : 'desc';
  const btn = document.getElementById('sort-dir-' + page);
  if (btn) { btn.className = 'sort-dir ' + sortDirs[page]; }
  if (page === 'records') renderRecords();
  else renderCatalog();
}

function getSortValue(r, field) {
  const buyRate = rates[r.currency] || 1;
  switch(field) {
    case 'price': return (parseFloat(r.price) || 0) * buyRate;
    case 'margin': return calcMargin(r) ?? -999;
    case 'qty': return parseFloat(r.qty) || 0;
    case 'shipping': return (parseFloat(r.shipping) || 0) * buyRate;
    case 'date': default: return r.id || '0';
  }
}

function applySort(list, pageId) {
  const field = document.getElementById('sort-field-' + pageId)?.value || 'date';
  const dir = sortDirs[pageId] || 'desc';
  return [...list].sort((a, b) => {
    const va = getSortValue(a, field);
    const vb = getSortValue(b, field);
    if (va < vb) return dir === 'asc' ? -1 : 1;
    if (va > vb) return dir === 'asc' ? 1 : -1;
    return 0;
  });
}

function populateFilterDropdowns() {
  const cities    = [...new Set(records.map(r => r.city).filter(Boolean))].sort();
  const countries = [...new Set(records.map(r => r.country).filter(Boolean))].sort();
  const stores    = [...new Set(records.map(r => r.store).filter(Boolean))].sort();

  const fill = (id, label, list) => {
    const el = document.getElementById(id);
    if (!el) return;
    const cur = el.value;
    el.innerHTML = `<option value="">${label}</option>`
      + list.map(v => `<option value="${v}" ${v===cur?'selected':''}>${v}</option>`).join('');
  };
  fill('filter-city',        'æ‰€æœ‰åŸå¸‚', cities);
  fill('filter-city-cat',    'æ‰€æœ‰åŸå¸‚', cities);
  fill('filter-country',     'æ‰€æœ‰åœ‹å®¶', countries);
  fill('filter-country-cat', 'æ‰€æœ‰åœ‹å®¶', countries);
  fill('filter-store',       'æ‰€æœ‰åº—å', stores);
  fill('filter-store-cat',   'æ‰€æœ‰åº—å', stores);
}

function setFilter(filter, btn) {
  currentFilter = filter;
  document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
  btn.classList.add('active');
  renderRecords();
}

function renderSummary() {
  const recs = records.filter(r => r.mode !== 'æš«å­˜ç›®éŒ„');
  const bizRecs = recs.filter(r => r.type === 'æ¥­å‹™' && r.price && r.currency);
  const personalRecs = recs.filter(r => r.type === 'ç§äºº' && r.price && r.currency);

  function calcTotal(arr) {
    let twd = 0;
    const byCur = {};
    arr.forEach(r => {
      const p = parseFloat(r.price) || 0;
      byCur[r.currency] = (byCur[r.currency] || 0) + p;
      twd += toTWD(r.price, r.currency) || 0;
    });
    return { byCur, twd };
  }

  const bizTotal = calcTotal(bizRecs);
  const personalTotal = calcTotal(personalRecs);
  const allTotal = calcTotal(recs.filter(r => r.price && r.currency));

  function renderBlock(title, data, count) {
    const curRows = Object.entries(data.byCur).map(([c, v]) => {
      const twdEq = c !== 'TWD' ? ` <span style="font-size:11px;color:var(--gold);font-style:italic">â‰ˆ TWD ${Math.round(v * rates[c]).toLocaleString()}</span>` : '';
      return `<div class="summary-row">
        <span>${c}</span>
        <span class="summary-amount">${v.toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:2})} ${c}${twdEq}</span>
      </div>`;
    }).join('');
    const divider = Object.keys(data.byCur).length > 0 ? `<div style="border-top:1px solid var(--divider);margin:6px 0"></div>` : '';
    return `<div class="summary-card">
      <div class="summary-card-title">${title} <span style="font-size:12px;color:var(--light)">(${count} ä»¶)</span></div>
      ${curRows}
      ${divider}
      <div class="summary-row"><span style="font-weight:500">åˆè¨ˆæŠ˜å°å¹£</span><span class="summary-amount" style="color:var(--gold);font-size:20px">TWD ${data.twd.toLocaleString()}</span></div>
    </div>`;
  }

  const statusCount = {
    buy: recs.filter(r => r.status === 'buy').length,
    bought: recs.filter(r => r.status === 'bought').length,
    pass: recs.filter(r => r.status === 'pass').length,
  };

  document.getElementById('summary-content').innerHTML = `
    <div class="summary-card">
      <div class="summary-card-title">ä»Šæ—¥ç‹€æ…‹</div>
      <div class="summary-row"><span>è¦è²·</span><span class="summary-amount" style="color:var(--status-buy)">${statusCount.buy} ä»¶</span></div>
      <div class="summary-row"><span>å·²è²·</span><span class="summary-amount" style="color:var(--status-bought)">${statusCount.bought} ä»¶</span></div>
      <div class="summary-row"><span>æ”¾æ£„</span><span class="summary-amount" style="color:var(--status-pass)">${statusCount.pass} ä»¶</span></div>
    </div>
    ${renderBlock('æ¥­å‹™èŠ±è²»', bizTotal, bizRecs.length)}
    ${renderBlock('ç§äººèŠ±è²»', personalTotal, personalRecs.length)}
    ${renderBlock('åˆè¨ˆ', allTotal, recs.filter(r => r.price && r.currency).length)}
  `;
}

// Batch currency
function openBatchCurrencyModal() {
  const noCurrency = records.filter(r => !r.currency);
  const list = document.getElementById('batch-list');
  batchSelections = {};
  if (!noCurrency.length) {
    list.innerHTML = `<p style="font-size:12px;color:var(--light);letter-spacing:1.5px">æ‰€æœ‰ç´€éŒ„å‡å·²å¡«å¹£åˆ¥</p>`;
  } else {
    list.innerHTML = noCurrency.map(r => `
      <div class="batch-item">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
          <input type="checkbox" id="bsel-${r.id}" onchange="toggleBatchSel('${r.id}',this)">
          <span>${r.name || 'ï¼ˆæœªå‘½åï¼‰'} â€” ${r.price || 'ç„¡åƒ¹æ ¼'} â€” ${r.date || ''}</span>
        </label>
      </div>`).join('');
  }
  document.getElementById('batch-currency-modal').classList.add('open');
}

function toggleBatchSel(id, cb) {
  if (cb.checked) batchSelections[id] = true;
  else delete batchSelections[id];
}

async function applyBatchCurrency() {
  const cur = document.getElementById('batch-currency').value;
  for (const id of Object.keys(batchSelections)) {
    const rec = records.find(r => r.id === id);
    if (rec) {
      rec.currency = cur;
      const recNoPhoto = { ...rec }; delete recNoPhoto.photo;
      await dbPut('records', recNoPhoto);
    }
  }
  renderRecords();
  closeModal('batch-currency-modal');
  toast(`å·²å¥—ç”¨ ${cur}`);
}

// Batch status
function openBatchModal() {
  const recs = records.filter(r => r.mode !== 'æš«å­˜ç›®éŒ„');
  const list = document.getElementById('batch-status-list');
  list.innerHTML = recs.map(r => `
    <div class="batch-item">
      <span style="flex:1">${r.name || 'ï¼ˆæœªå‘½åï¼‰'} ${r.price ? r.price + (r.currency||'') : ''}</span>
      <div style="display:flex;gap:4px">
        <button class="status-btn s-buy ${r.status==='buy'?'active':''}" onclick="batchSetStatus('${r.id}','buy',this)">è¦è²·</button>
        <button class="status-btn s-bought ${r.status==='bought'?'active':''}" onclick="batchSetStatus('${r.id}','bought',this)">å·²è²·</button>
        <button class="status-btn s-pass ${r.status==='pass'?'active':''}" onclick="batchSetStatus('${r.id}','pass',this)">æ”¾æ£„</button>
      </div>
    </div>`).join('') || '<p style="font-size:12px;color:var(--light)">æš«ç„¡ç´€éŒ„</p>';
  document.getElementById('batch-modal').classList.add('open');
}

function batchSetStatus(id, status, btn) {
  const rec = records.find(r => r.id === id);
  if (!rec) return;
  rec.status = rec.status === status ? '' : status;
  const parent = btn.closest('.batch-item');
  parent.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active'));
  if (rec.status) btn.classList.add('active');
}

async function saveBatchStatus() {
  for (const rec of records) {
    const recNoPhoto = { ...rec }; delete recNoPhoto.photo;
    await dbPut('records', recNoPhoto);
  }
  renderRecords();
  closeModal('batch-modal');
  toast('å·²å„²å­˜æ¨™è¨˜');
}

// CSV export
function exportCSV(type) {
  let data = records.filter(r => r.mode !== 'æš«å­˜ç›®éŒ„');
  let filename = 'æ¡è³¼ç´€éŒ„';
  if (type === 'biz') { data = data.filter(r => r.type === 'æ¥­å‹™'); filename = 'æ¥­å‹™æ¡è³¼'; }
  if (type === 'personal') { data = data.filter(r => r.type === 'ç§äºº'); filename = 'ç§äººæ¡è³¼'; }

  const headers = ['æ—¥æœŸ','å•†å“åç¨±','æ•¸é‡','æ¡è³¼åƒ¹','å¹£åˆ¥','æ¡è³¼åƒ¹(TWD)','å”®åƒ¹(TWD)','æ¯›åˆ©ç‡(%)','é‹è²»(TWD)','åŸå¸‚','åº—å','åˆ†é¡','ç”¨é€”','ç‹€æ…‹','æœ‰æŠ˜æ‰£','æŠ˜å¾Œåƒ¹','æŠ˜æ‰£å‚™è¨»','å‚™è¨»'];
  const rows = data.map(r => [
    r.date || '', r.name || '', r.qty || '', r.price || '', r.currency || '',
    toTWD(r.price, r.currency) || '', r.sellPrice || '', calcMargin(r) !== null ? calcMargin(r) : '',
    r.shipping || '', r.city || '', r.store || '', r.category || '', r.type || '', r.status || '',
    r.hasDiscount ? 'æ˜¯' : 'å¦', r.discountPrice || '', r.discountNote || '', r.note || ''
  ]);

  const csv = [headers, ...rows].map(row => row.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const bom = '\ufeff';
  const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${filename}_${new Date().toLocaleDateString('zh-TW').replace(/\//g,'-')}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  toast('CSV åŒ¯å‡ºå®Œæˆ');
}

async function exportExcel(type) {
  // Load SheetJS if not already loaded
  if (!window.XLSX) {
    await new Promise((resolve, reject) => {
      const s = document.createElement('script');
      s.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
      s.onload = resolve; s.onerror = reject;
      document.head.appendChild(s);
    });
  }

  let data = records.filter(r => r.mode !== 'æš«å­˜ç›®éŒ„');
  let filename = 'æ¡è³¼ç´€éŒ„';
  if (type === 'biz') { data = data.filter(r => r.type === 'æ¥­å‹™'); filename = 'æ¥­å‹™æ¡è³¼'; }
  if (type === 'personal') { data = data.filter(r => r.type === 'ç§äºº'); filename = 'ç§äººæ¡è³¼'; }

  toast('æº–å‚™åŒ¯å‡ºä¸­...');

  const wb = XLSX.utils.book_new();
  const wsData = [
    ['æ—¥æœŸ','å•†å“åç¨±','ç…§ç‰‡','æ•¸é‡','æ¡è³¼åƒ¹','å¹£åˆ¥','æ¡è³¼åƒ¹(TWD)','å”®åƒ¹(TWD)','æ¯›åˆ©ç‡(%)','é‹è²»(TWD)','åŸå¸‚','åº—å','åˆ†é¡','ç”¨é€”','ç‹€æ…‹','æœ‰æŠ˜æ‰£','æŠ˜å¾Œåƒ¹','æŠ˜æ‰£å‚™è¨»','å‚™è¨»']
  ];

  for (const r of data) {
    wsData.push([
      r.date || '', r.name || '', r.photo ? '(è¦‹åœ–)' : '', r.qty || '',
      r.price || '', r.currency || '', toTWD(r.price, r.currency) || '',
      r.sellPrice || '', calcMargin(r) !== null ? calcMargin(r) : '',
      r.shipping || '', r.city || '', r.store || '', r.category || '',
      r.type || '', r.status || '',
      r.hasDiscount ? 'æ˜¯' : 'å¦', r.discountPrice || '', r.discountNote || '', r.note || ''
    ]);
  }

  const ws = XLSX.utils.aoa_to_sheet(wsData);

  // Set column widths
  ws['!cols'] = [
    {wch:10},{wch:20},{wch:12},{wch:6},{wch:10},{wch:6},{wch:12},{wch:12},{wch:8},
    {wch:10},{wch:10},{wch:16},{wch:10},{wch:6},{wch:6},{wch:6},{wch:10},{wch:16},{wch:30}
  ];

  // Embed photos as images using row height + drawingml approach
  // We'll use a simpler approach: convert photos to base64 and add as separate sheet
  const photoRecs = data.filter(r => r.photo);
  if (photoRecs.length > 0) {
    // Add photos to a second sheet as references
    const photoData2 = [['å•†å“åç¨±', 'æ—¥æœŸ', 'åŸå¸‚', 'åº—å', 'åƒ¹æ ¼', 'å‚™è¨»', 'ç…§ç‰‡ (Base64 é è¦½)']];
    for (const r of photoRecs) {
      let b64 = '';
      try {
        // Convert blob URL to base64
        const resp = await fetch(r.photo);
        const blob = await resp.blob();
        b64 = await new Promise(res => {
          const reader = new FileReader();
          reader.onload = e => res(e.target.result);
          reader.readAsDataURL(blob);
        });
      } catch(e) { b64 = r.photo || ''; }
      photoData2.push([r.name || '(æœªå‘½å)', r.date || '', r.city || '', r.store || '',
        (r.price || '') + ' ' + (r.currency || ''), r.note || '', b64.substring(0, 100) + '...']);
    }
    const ws2 = XLSX.utils.aoa_to_sheet(photoData2);
    XLSX.utils.book_append_sheet(wb, ws2, 'ç…§ç‰‡æ¸…å–®');

    // Also create an HTML file with embedded photos for download
    let htmlContent = `<!DOCTYPE html><html><head><meta charset="UTF-8">
<title>${filename} ç…§ç‰‡ç¸½è¦½</title>
<style>
body{font-family:sans-serif;background:#f5f0e8;padding:20px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px}
.card{background:white;border-radius:8px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
.card img{width:100%;height:160px;object-fit:cover}
.card-info{padding:10px;font-size:12px}
.card-name{font-weight:bold;margin-bottom:4px}
.card-meta{color:#888}
</style></head><body>
<h2 style="color:#2a2218;letter-spacing:3px;margin-bottom:20px">${filename} Â· ç…§ç‰‡ç¸½è¦½</h2>
<div class="grid">`;

    for (const r of photoRecs) {
      let b64 = r.photo;
      try {
        const resp = await fetch(r.photo);
        const blob = await resp.blob();
        b64 = await new Promise(res => {
          const reader = new FileReader();
          reader.onload = e => res(e.target.result);
          reader.readAsDataURL(blob);
        });
      } catch(e) {}
      htmlContent += `<div class="card">
        <img src="${b64}" alt="${r.name || ''}">
        <div class="card-info">
          <div class="card-name">${r.name || '(æœªå‘½å)'}</div>
          <div class="card-meta">${r.price ? r.price + ' ' + (r.currency||'') : ''} ${r.city ? 'Â· ' + r.city : ''} ${r.store ? r.store : ''}</div>
          <div class="card-meta">${r.note || ''}</div>
        </div>
      </div>`;
    }
    htmlContent += `</div></body></html>`;

    // Download photo HTML
    const htmlBlob = new Blob([htmlContent], {type: 'text/html;charset=utf-8'});
    const htmlUrl = URL.createObjectURL(htmlBlob);
    const ha = document.createElement('a');
    ha.href = htmlUrl;
    ha.download = `${filename}_ç…§ç‰‡_${new Date().toLocaleDateString('zh-TW').replace(/\//g,'-')}.html`;
    ha.click();
    URL.revokeObjectURL(htmlUrl);
  }

  XLSX.utils.book_append_sheet(wb, ws, 'æ¡è³¼ç´€éŒ„');
  const dateStr = new Date().toLocaleDateString('zh-TW').replace(/\//g,'-');
  XLSX.write(wb, {bookType:'xlsx', type:'array'});
  const xlsxBlob = new Blob([XLSX.write(wb, {bookType:'xlsx', type:'array'})], {type:'application/octet-stream'});
  const url = URL.createObjectURL(xlsxBlob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${filename}_${dateStr}.xlsx`;
  a.click();
  URL.revokeObjectURL(url);
  toast('Excel åŒ¯å‡ºå®Œæˆï¼ç…§ç‰‡å¦å­˜ç‚º HTML æª”');
}

async function clearAll() {
  if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Ÿ')) {
    records = [];
    await dbClear('records');
    await dbClear('photos');
    renderRecords();
    renderCatalog();
    toast('å·²æ¸…é™¤');
  }
}

function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

// Init
openDB().then(async () => {
  await loadRates();
  await loadAllRecords();
  renderRecords();
}).catch(err => {
  console.error('DB init failed', err);
  // fallback: just render empty
  loadRateInputs();
  renderRecords();
});
</script>
</body>
</html>
